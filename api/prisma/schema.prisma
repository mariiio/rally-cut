generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String                @id @default(uuid())
  email               String?               @unique
  name                String?
  avatarUrl           String?               @map("avatar_url")
  emailVerified       DateTime?             @map("email_verified")
  passwordHash        String?               @map("password_hash")
  tier                UserTier              @default(FREE)
  tierExpiresAt       DateTime?             @map("tier_expires_at")
  createdAt           DateTime              @default(now()) @map("created_at")
  convertedAt         DateTime?             @map("converted_at")
  /// Last time user accessed content (for inactivity cleanup)
  lastActiveAt        DateTime?             @map("last_active_at")
  resolvedRequests    AccessRequest[]       @relation("resolvedRequests")
  accessRequests      AccessRequest[]       @relation("accessRequests")
  accounts            Account[]
  anonymousIdentities AnonymousIdentity[]
  feedback            Feedback[]
  highlights          Highlight[]
  cameraEdits         RallyCameraEdit[]
  sessionMemberships  SessionMember[]
  sessions            Session[]
  usageQuota          UserUsageQuota?
  videoCameraSettings VideoCameraSettings[]
  videoMemberships    VideoMember[]
  videos              Video[]

  @@index([tier])
  @@map("users")
}

model Account {
  id                String  @id @default(uuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model UserUsageQuota {
  id               String   @id @default(uuid())
  userId           String   @unique @map("user_id")
  periodStart      DateTime @map("period_start")
  detectionsUsed   Int      @default(0) @map("detections_used")
  uploadsThisMonth Int      @default(0) @map("uploads_this_month")
  createdAt        DateTime @default(now()) @map("created_at")
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_usage_quotas")
}

model AnonymousIdentity {
  id        String   @id @default(uuid())
  visitorId String   @unique @map("visitor_id")
  userId    String   @map("user_id")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("anonymous_identities")
}

model SessionShare {
  id        String          @id @default(uuid())
  sessionId String          @map("session_id")
  token     String          @unique @default(uuid())
  role      MemberRole      @default(VIEWER)
  createdAt DateTime        @default(now()) @map("created_at")
  members   SessionMember[]
  session   Session         @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, role])
  @@index([sessionId])
  @@map("session_shares")
}

model SessionMember {
  id             String       @id @default(uuid())
  sessionShareId String       @map("session_share_id")
  userId         String       @map("user_id")
  role           MemberRole   @default(VIEWER)
  joinedAt       DateTime     @default(now()) @map("joined_at")
  sessionShare   SessionShare @relation(fields: [sessionShareId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionShareId, userId])
  @@index([userId])
  @@index([sessionShareId])
  @@map("session_members")
}

model VideoShare {
  id        String        @id @default(uuid())
  videoId   String        @map("video_id")
  token     String        @unique @default(uuid())
  role      MemberRole    @default(VIEWER)
  createdAt DateTime      @default(now()) @map("created_at")
  members   VideoMember[]
  video     Video         @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([videoId, role])
  @@index([videoId])
  @@map("video_shares")
}

model VideoMember {
  id           String     @id @default(uuid())
  videoShareId String     @map("video_share_id")
  userId       String     @map("user_id")
  role         MemberRole @default(VIEWER)
  joinedAt     DateTime   @default(now()) @map("joined_at")
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  videoShare   VideoShare @relation(fields: [videoShareId], references: [id], onDelete: Cascade)

  @@unique([videoShareId, userId])
  @@index([userId])
  @@index([videoShareId])
  @@map("video_members")
}

model AccessRequest {
  id          String              @id @default(uuid())
  sessionId   String              @map("session_id")
  userId      String              @map("user_id")
  status      AccessRequestStatus @default(PENDING)
  message     String?
  requestedAt DateTime            @default(now()) @map("requested_at")
  resolvedAt  DateTime?           @map("resolved_at")
  resolvedBy  String?             @map("resolved_by")
  resolver    User?               @relation("resolvedRequests", fields: [resolvedBy], references: [id])
  session     Session             @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user        User                @relation("accessRequests", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, userId])
  @@index([sessionId, status])
  @@index([userId])
  @@map("access_requests")
}

model Session {
  id             String          @id @default(uuid())
  userId         String?         @map("user_id")
  name           String
  type           SessionType     @default(REGULAR)
  expiresAt      DateTime?       @map("expires_at")
  deletedAt      DateTime?       @map("deleted_at")
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  accessRequests AccessRequest[]
  exportJobs     ExportJob[]
  highlights     Highlight[]
  shares         SessionShare[]
  sessionVideos  SessionVideo[]
  user           User?           @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([userId, deletedAt])
  @@index([expiresAt])
  @@index([deletedAt])
  @@map("sessions")
}

model Video {
  id                    String                @id @default(uuid())
  userId                String?               @map("user_id")
  name                  String
  filename              String
  s3Key                 String                @map("s3_key")
  /// SHA-256 hex hash for deduplication. Files >50MB: hash of first/last 10MB + metadata.
  contentHash           String                @map("content_hash")
  status                VideoStatus           @default(PENDING)
  durationMs            Int?                  @map("duration_ms")
  width                 Int?
  height                Int?
  /// Frames per second of original video
  fps                   Float?
  fileSizeBytes         BigInt?               @map("file_size_bytes")
  expiresAt             DateTime?             @map("expires_at")
  deletedAt             DateTime?             @map("deleted_at")
  createdAt             DateTime              @default(now()) @map("created_at")
  updatedAt             DateTime              @updatedAt @map("updated_at")
  processingStatus      ProcessingStatus      @default(PENDING) @map("processing_status")
  processingAttempts    Int                   @default(0) @map("processing_attempts")
  processedS3Key        String?               @map("processed_s3_key")
  /// Original upload path before optimization overwrites s3Key
  originalS3Key         String?               @map("original_s3_key")
  processedAt           DateTime?             @map("processed_at")
  processingError       String?               @map("processing_error")
  originalFileSizeBytes BigInt?               @map("original_file_size_bytes")
  posterS3Key           String?               @map("poster_s3_key")
  proxyS3Key            String?               @map("proxy_s3_key")
  proxyFileSizeBytes    BigInt?               @map("proxy_file_size_bytes")
  proxyGeneratedAt      DateTime?             @map("proxy_generated_at")
  proxyLastAccessedAt   DateTime?             @map("proxy_last_accessed_at")
  qualityDowngradedAt   DateTime?             @map("quality_downgraded_at")
  courtCalibrationJson  Json?                 @map("court_calibration_json")
  characteristicsJson   Json?                 @map("characteristics_json")
  rallies               Rally[]
  confirmation          RallyConfirmation?
  detectionJobs         RallyDetectionJob[]
  sessionVideos         SessionVideo[]
  cameraSettings        VideoCameraSettings[]
  shares                VideoShare[]
  user                  User?                 @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([userId, deletedAt])
  @@index([contentHash])
  @@index([status])
  @@index([expiresAt])
  @@index([deletedAt])
  @@index([processingStatus])
  @@map("videos")
}

model SessionVideo {
  id        String   @id @default(uuid())
  sessionId String   @map("session_id")
  videoId   String   @map("video_id")
  order     Int      @default(0)
  addedAt   DateTime @default(now()) @map("added_at")
  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  video     Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([sessionId, videoId])
  @@index([sessionId])
  @@index([videoId])
  @@map("session_videos")
}

model Rally {
  id               String            @id @default(uuid())
  videoId          String            @map("video_id")
  startMs          Int               @map("start_ms")
  endMs            Int               @map("end_ms")
  confidence       Float?
  status           RallyStatus       @default(CONFIRMED)
  rejectionReason  RejectionReason?  @map("rejection_reason")
  scoreA           Int?              @map("score_a")
  scoreB           Int?              @map("score_b")
  servingTeam      ServingTeam?      @map("serving_team")
  notes            String?
  order            Int               @default(0)
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  highlightRallies HighlightRally[]
  playerTrack      PlayerTrack?
  video            Video             @relation(fields: [videoId], references: [id], onDelete: Cascade)
  cameraEdits      RallyCameraEdit[]

  @@index([videoId])
  @@index([videoId, startMs])
  @@index([videoId, status])
  @@map("rallies")
}

model PlayerTrack {
  id                  String            @id @default(uuid())
  rallyId             String            @unique @map("rally_id")
  status              PlayerTrackStatus @default(PENDING)
  frameCount          Int?              @map("frame_count")
  processingTimeMs    Int?              @map("processing_time_ms")
  modelVersion        String?           @map("model_version")
  error               String?
  createdAt           DateTime          @default(now()) @map("created_at")
  completedAt         DateTime?         @map("completed_at")
  avgConfidence       Float?            @map("avg_confidence")
  avgPlayerCount      Float?            @map("avg_player_count")
  courtSplitY         Float?            @map("court_split_y")
  detectionRate       Float?            @map("detection_rate")
  positionsJson       Json?             @map("positions_json")
  rawPositionsJson    Json?             @map("raw_positions_json")
  primaryTrackIds     Json?             @map("primary_track_ids")
  uniqueTrackCount    Int?              @map("unique_track_count")
  fps                 Float?            @map("fps")
  ballPositionsJson   Json?             @map("ball_positions_json")
  contactsJson        Json?             @map("contacts_json")
  actionsJson         Json?             @map("actions_json")
  groundTruthJson     Json?             @map("ground_truth_json")
  groundTruthTaskId   Int?              @map("ground_truth_task_id")
  groundTruthSyncedAt DateTime?         @map("ground_truth_synced_at") @db.Timestamptz(6)
  rally               Rally             @relation(fields: [rallyId], references: [id], onDelete: Cascade)

  @@index([rallyId])
  @@index([status])
  @@map("player_tracks")
}

model RallyCameraEdit {
  id          String           @id @default(uuid())
  rallyId     String           @map("rally_id")
  userId      String?          @map("user_id")
  aspectRatio AspectRatio      @default(ORIGINAL) @map("aspect_ratio")
  enabled     Boolean          @default(false)
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")
  keyframes   CameraKeyframe[]
  rally       Rally            @relation(fields: [rallyId], references: [id], onDelete: Cascade)
  user        User?            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([rallyId, userId])
  @@index([userId])
  @@map("rally_camera_edits")
}

model CameraKeyframe {
  id              String          @id @default(uuid())
  rallyCameraId   String          @map("rally_camera_id")
  timeOffset      Float           @map("time_offset")
  positionX       Float           @default(0.5) @map("position_x")
  positionY       Float           @default(0.5) @map("position_y")
  zoom            Float           @default(1.0)
  rotation        Float           @default(0.0)
  easing          CameraEasing    @default(EASE_IN_OUT)
  createdAt       DateTime        @default(now()) @map("created_at")
  rallyCameraEdit RallyCameraEdit @relation(fields: [rallyCameraId], references: [id], onDelete: Cascade)

  @@index([rallyCameraId])
  @@map("camera_keyframes")
}

model VideoCameraSettings {
  id        String   @id @default(uuid())
  videoId   String   @map("video_id")
  userId    String?  @map("user_id")
  zoom      Float    @default(1.0)
  positionX Float    @default(0.5) @map("position_x")
  positionY Float    @default(0.5) @map("position_y")
  rotation  Float    @default(0.0)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  video     Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([videoId, userId])
  @@index([userId])
  @@map("video_camera_settings")
}

model Highlight {
  id               String           @id @default(uuid())
  sessionId        String           @map("session_id")
  createdByUserId  String?          @map("created_by_user_id")
  name             String
  color            String           @default("#FF6B6B")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")
  highlightRallies HighlightRally[]
  createdByUser    User?            @relation(fields: [createdByUserId], references: [id])
  session          Session          @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([createdByUserId])
  @@map("highlights")
}

model HighlightRally {
  id          String    @id @default(uuid())
  highlightId String    @map("highlight_id")
  rallyId     String    @map("rally_id")
  order       Int       @default(0)
  highlight   Highlight @relation(fields: [highlightId], references: [id], onDelete: Cascade)
  rally       Rally     @relation(fields: [rallyId], references: [id], onDelete: Cascade)

  @@unique([highlightId, rallyId])
  @@index([rallyId])
  @@map("highlight_rallies")
}

model RallyDetectionJob {
  id              String             @id @default(uuid())
  videoId         String             @map("video_id")
  /// SHA-256 hex hash for caching detection results across uploads with same content.
  contentHash     String             @map("content_hash")
  status          DetectionJobStatus @default(PENDING)
  progress        Float?             @default(0)
  progressMessage String?            @map("progress_message")
  resultS3Key     String?            @map("result_s3_key")
  errorMessage    String?            @map("error_message")
  startedAt       DateTime?          @map("started_at")
  completedAt     DateTime?          @map("completed_at")
  createdAt       DateTime           @default(now()) @map("created_at")
  video           Video              @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([videoId])
  @@index([status])
  @@index([contentHash, status])
  @@map("rally_detection_jobs")
}

model ExportJob {
  id        String       @id @default(uuid())
  sessionId String       @map("session_id")
  userId    String       @map("user_id")
  tier      UserTier     @default(FREE)
  status    ExportStatus @default(PENDING)
  progress  Int          @default(0)
  outputKey String?      @map("output_key")
  error     String?
  config    Json
  rallies   Json
  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")
  session   Session      @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([userId])
  @@index([status])
  @@map("export_jobs")
}

model RallyConfirmation {
  id                 String             @id @default(uuid())
  videoId            String             @unique @map("video_id")
  status             ConfirmationStatus @default(PENDING)
  originalS3Key      String             @map("original_s3_key")
  originalDurationMs Int                @map("original_duration_ms")
  trimmedS3Key       String?            @map("trimmed_s3_key")
  trimmedDurationMs  Int?               @map("trimmed_duration_ms")
  proxyS3Key         String?            @map("proxy_s3_key")
  timestampMappings  Json               @map("timestamp_mappings")
  progress           Int                @default(0)
  error              String?
  createdAt          DateTime           @default(now()) @map("created_at")
  confirmedAt        DateTime?          @map("confirmed_at")
  video              Video              @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([videoId])
  @@index([status])
  @@map("rally_confirmations")
}

model Feedback {
  id        String       @id @default(uuid())
  userId    String?      @map("user_id")
  type      FeedbackType
  message   String
  email     String?
  userAgent String?      @map("user_agent")
  pageUrl   String?      @map("page_url")
  createdAt DateTime     @default(now()) @map("created_at")
  user      User?        @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([type])
  @@map("feedback")
}

enum UserTier {
  FREE
  PRO
  ELITE
}

enum MemberRole {
  VIEWER
  EDITOR
  ADMIN
}

enum AccessRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum SessionType {
  REGULAR
  ALL_VIDEOS
}

enum VideoStatus {
  PENDING
  UPLOADED
  DETECTING
  DETECTED
  ERROR
}

enum ProcessingStatus {
  PENDING
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
  SKIPPED
}

enum PlayerTrackStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum AspectRatio {
  ORIGINAL
  VERTICAL
}

enum CameraEasing {
  LINEAR
  EASE_IN
  EASE_OUT
  EASE_IN_OUT
}

enum ServingTeam {
  A
  B
}

enum RallyStatus {
  CONFIRMED
  SUGGESTED
}

enum RejectionReason {
  INSUFFICIENT_WINDOWS
  TOO_SHORT
  SPARSE_DENSITY
}

enum DetectionJobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

enum ExportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum ConfirmationStatus {
  PENDING
  PROCESSING
  CONFIRMED
  FAILED
}

enum FeedbackType {
  BUG
  FEATURE
  FEEDBACK
}
