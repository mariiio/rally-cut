generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// User & Identity
// ============================================================================

model User {
  id          String    @id @default(uuid())
  email       String?   @unique
  name        String?
  avatarUrl   String?   @map("avatar_url")
  createdAt   DateTime  @default(now()) @map("created_at")
  convertedAt DateTime? @map("converted_at")

  videos              Video[]
  sessions            Session[]
  anonymousIdentities AnonymousIdentity[]
  sessionMemberships  SessionMember[]
  highlights          Highlight[]

  @@map("users")
}

model AnonymousIdentity {
  id        String   @id @default(uuid())
  visitorId String   @unique @map("visitor_id")
  userId    String   @map("user_id")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("anonymous_identities")
}

// ============================================================================
// Session Sharing
// ============================================================================

model SessionShare {
  id        String   @id @default(uuid())
  sessionId String   @unique @map("session_id")
  token     String   @unique @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")

  session Session         @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  members SessionMember[]

  @@map("session_shares")
}

model SessionMember {
  id             String   @id @default(uuid())
  sessionShareId String   @map("session_share_id")
  userId         String   @map("user_id")
  joinedAt       DateTime @default(now()) @map("joined_at")

  sessionShare SessionShare @relation(fields: [sessionShareId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionShareId, userId])
  @@index([userId])
  @@map("session_members")
}

// ============================================================================
// Session & Video (Many-to-Many via SessionVideo)
// ============================================================================

enum SessionType {
  REGULAR
  ALL_VIDEOS
}

model Session {
  id        String      @id @default(uuid())
  userId    String?     @map("user_id")
  name      String
  type      SessionType @default(REGULAR)
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")

  user          User?          @relation(fields: [userId], references: [id], onDelete: SetNull)
  sessionVideos SessionVideo[]
  highlights    Highlight[]
  share         SessionShare?
  exportJobs    ExportJob[]

  @@unique([userId, type])
  @@index([userId])
  @@map("sessions")
}

model Video {
  id            String      @id @default(uuid())
  userId        String?     @map("user_id")
  name          String
  filename      String
  s3Key         String      @map("s3_key")
  contentHash   String      @map("content_hash")
  status        VideoStatus @default(PENDING)
  durationMs    Int?        @map("duration_ms")
  width         Int?
  height        Int?
  fileSizeBytes BigInt?     @map("file_size_bytes")
  deletedAt     DateTime?   @map("deleted_at")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  user          User?               @relation(fields: [userId], references: [id], onDelete: SetNull)
  sessionVideos SessionVideo[]
  rallies       Rally[]
  detectionJobs RallyDetectionJob[]

  @@index([userId])
  @@index([contentHash])
  @@map("videos")
}

model SessionVideo {
  id        String   @id @default(uuid())
  sessionId String   @map("session_id")
  videoId   String   @map("video_id")
  order     Int      @default(0)
  addedAt   DateTime @default(now()) @map("added_at")

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  video   Video   @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([sessionId, videoId])
  @@index([sessionId])
  @@index([videoId])
  @@map("session_videos")
}

enum VideoStatus {
  PENDING
  UPLOADED
  DETECTING
  DETECTED
  ERROR
}

// ============================================================================
// Rally & Highlight
// ============================================================================

model Rally {
  id          String       @id @default(uuid())
  videoId     String       @map("video_id")
  startMs     Int          @map("start_ms")
  endMs       Int          @map("end_ms")
  confidence  Float?
  scoreA      Int?         @map("score_a")
  scoreB      Int?         @map("score_b")
  servingTeam ServingTeam? @map("serving_team")
  notes       String?
  order       Int          @default(0)
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  video            Video            @relation(fields: [videoId], references: [id], onDelete: Cascade)
  highlightRallies HighlightRally[]

  @@index([videoId])
  @@map("rallies")
}

enum ServingTeam {
  A
  B
}

model Highlight {
  id              String   @id @default(uuid())
  sessionId       String   @map("session_id")
  createdByUserId String?  @map("created_by_user_id")
  name            String
  color           String   @default("#FF6B6B")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  session          Session          @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  createdByUser    User?            @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)
  highlightRallies HighlightRally[]

  @@index([sessionId])
  @@index([createdByUserId])
  @@map("highlights")
}

model HighlightRally {
  id          String @id @default(uuid())
  highlightId String @map("highlight_id")
  rallyId     String @map("rally_id")
  order       Int    @default(0)

  highlight Highlight @relation(fields: [highlightId], references: [id], onDelete: Cascade)
  rally     Rally     @relation(fields: [rallyId], references: [id], onDelete: Cascade)

  @@unique([highlightId, rallyId])
  @@map("highlight_rallies")
}

// ============================================================================
// Detection Jobs
// ============================================================================

model RallyDetectionJob {
  id              String             @id @default(uuid())
  videoId         String             @map("video_id")
  contentHash     String             @map("content_hash")
  status          DetectionJobStatus @default(PENDING)
  progress        Float?             @default(0)
  progressMessage String?            @map("progress_message")
  resultS3Key     String?            @map("result_s3_key")
  errorMessage    String?            @map("error_message")
  startedAt       DateTime?          @map("started_at")
  completedAt     DateTime?          @map("completed_at")
  createdAt       DateTime           @default(now()) @map("created_at")

  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([contentHash, status])
  @@map("rally_detection_jobs")
}

enum DetectionJobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

// ============================================================================
// Export Jobs
// ============================================================================

model ExportJob {
  id        String       @id @default(uuid())
  sessionId String       @map("session_id")
  userId    String       @map("user_id")
  tier      ExportTier   @default(FREE)
  status    ExportStatus @default(PENDING)
  progress  Int          @default(0)
  outputKey String?      @map("output_key")
  error     String?
  config    Json
  rallies   Json
  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([userId])
  @@map("export_jobs")
}

enum ExportTier {
  FREE
  PREMIUM
}

enum ExportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}
