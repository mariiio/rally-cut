generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// User & Identity
// ============================================================================

enum UserTier {
  FREE
  PREMIUM
}

model User {
  id            String    @id @default(uuid())
  email         String?   @unique
  name          String?
  avatarUrl     String?   @map("avatar_url")
  tier          UserTier  @default(FREE)
  tierExpiresAt DateTime? @map("tier_expires_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  convertedAt   DateTime? @map("converted_at")

  videos              Video[]
  sessions            Session[]
  anonymousIdentities AnonymousIdentity[]
  sessionMemberships  SessionMember[]
  highlights          Highlight[]
  usageQuota          UserUsageQuota?
  feedback            Feedback[]

  @@index([tier])
  @@map("users")
}

model UserUsageQuota {
  id               String   @id @default(uuid())
  userId           String   @unique @map("user_id")
  periodStart      DateTime @map("period_start")
  detectionsUsed   Int      @default(0) @map("detections_used")
  uploadsThisMonth Int      @default(0) @map("uploads_this_month")
  createdAt        DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_usage_quotas")
}

model AnonymousIdentity {
  id        String   @id @default(uuid())
  visitorId String   @unique @map("visitor_id")
  userId    String   @map("user_id")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("anonymous_identities")
}

// ============================================================================
// Session Sharing
// ============================================================================

model SessionShare {
  id        String   @id @default(uuid())
  sessionId String   @unique @map("session_id")
  token     String   @unique @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")

  session Session         @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  members SessionMember[]

  @@map("session_shares")
}

model SessionMember {
  id             String   @id @default(uuid())
  sessionShareId String   @map("session_share_id")
  userId         String   @map("user_id")
  joinedAt       DateTime @default(now()) @map("joined_at")

  sessionShare SessionShare @relation(fields: [sessionShareId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionShareId, userId])
  @@index([userId])
  @@index([sessionShareId])
  @@map("session_members")
}

// ============================================================================
// Session & Video (Many-to-Many via SessionVideo)
// ============================================================================

enum SessionType {
  REGULAR
  ALL_VIDEOS
}

model Session {
  id        String      @id @default(uuid())
  userId    String?     @map("user_id")
  name      String
  type      SessionType @default(REGULAR)
  expiresAt DateTime?   @map("expires_at")
  deletedAt DateTime?   @map("deleted_at")
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")

  user          User?          @relation(fields: [userId], references: [id], onDelete: SetNull)
  sessionVideos SessionVideo[]
  highlights    Highlight[]
  share         SessionShare?
  exportJobs    ExportJob[]

  @@index([userId])
  @@index([userId, deletedAt])
  @@index([expiresAt])
  @@index([deletedAt])
  @@map("sessions")
}

model Video {
  id            String      @id @default(uuid())
  userId        String?     @map("user_id")
  name          String
  filename      String
  s3Key         String      @map("s3_key")
  contentHash   String      @map("content_hash")
  status        VideoStatus @default(PENDING)
  durationMs    Int?        @map("duration_ms")
  width         Int?
  height        Int?
  fileSizeBytes BigInt?     @map("file_size_bytes")
  expiresAt     DateTime?   @map("expires_at")
  deletedAt     DateTime?   @map("deleted_at")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  // Video optimization processing
  processingStatus      ProcessingStatus @default(PENDING) @map("processing_status")
  processedS3Key        String?          @map("processed_s3_key")
  processedAt           DateTime?        @map("processed_at")
  processingError       String?          @map("processing_error")
  originalFileSizeBytes BigInt?          @map("original_file_size_bytes")

  // Poster and proxy for fast loading
  posterS3Key           String?          @map("poster_s3_key")
  proxyS3Key            String?          @map("proxy_s3_key")
  proxyFileSizeBytes    BigInt?          @map("proxy_file_size_bytes")
  proxyGeneratedAt      DateTime?        @map("proxy_generated_at")
  proxyLastAccessedAt   DateTime?        @map("proxy_last_accessed_at")

  user          User?               @relation(fields: [userId], references: [id], onDelete: SetNull)
  sessionVideos SessionVideo[]
  rallies       Rally[]
  detectionJobs RallyDetectionJob[]
  confirmation  RallyConfirmation?

  @@index([userId])
  @@index([userId, deletedAt])
  @@index([contentHash])
  @@index([status])
  @@index([expiresAt])
  @@index([deletedAt])
  @@index([processingStatus])
  @@map("videos")
}

model SessionVideo {
  id        String   @id @default(uuid())
  sessionId String   @map("session_id")
  videoId   String   @map("video_id")
  order     Int      @default(0)
  addedAt   DateTime @default(now()) @map("added_at")

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  video   Video   @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([sessionId, videoId])
  @@index([sessionId])
  @@index([videoId])
  @@map("session_videos")
}

enum VideoStatus {
  PENDING
  UPLOADED
  DETECTING
  DETECTED
  ERROR
}

enum ProcessingStatus {
  PENDING
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
  SKIPPED
}

// ============================================================================
// Rally & Highlight
// ============================================================================

model Rally {
  id          String       @id @default(uuid())
  videoId     String       @map("video_id")
  startMs     Int          @map("start_ms")
  endMs       Int          @map("end_ms")
  confidence  Float?
  scoreA      Int?         @map("score_a")
  scoreB      Int?         @map("score_b")
  servingTeam ServingTeam? @map("serving_team")
  notes       String?
  order       Int          @default(0)
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  video            Video            @relation(fields: [videoId], references: [id], onDelete: Cascade)
  highlightRallies HighlightRally[]

  @@index([videoId])
  @@index([videoId, startMs])
  @@map("rallies")
}

enum ServingTeam {
  A
  B
}

model Highlight {
  id              String   @id @default(uuid())
  sessionId       String   @map("session_id")
  createdByUserId String?  @map("created_by_user_id")
  name            String
  color           String   @default("#FF6B6B")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  session          Session          @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  createdByUser    User?            @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)
  highlightRallies HighlightRally[]

  @@index([sessionId])
  @@index([createdByUserId])
  @@map("highlights")
}

model HighlightRally {
  id          String @id @default(uuid())
  highlightId String @map("highlight_id")
  rallyId     String @map("rally_id")
  order       Int    @default(0)

  highlight Highlight @relation(fields: [highlightId], references: [id], onDelete: Cascade)
  rally     Rally     @relation(fields: [rallyId], references: [id], onDelete: Cascade)

  @@unique([highlightId, rallyId])
  @@index([rallyId])
  @@map("highlight_rallies")
}

// ============================================================================
// Detection Jobs
// ============================================================================

model RallyDetectionJob {
  id              String             @id @default(uuid())
  videoId         String             @map("video_id")
  contentHash     String             @map("content_hash")
  status          DetectionJobStatus @default(PENDING)
  progress        Float?             @default(0)
  progressMessage String?            @map("progress_message")
  resultS3Key     String?            @map("result_s3_key")
  errorMessage    String?            @map("error_message")
  startedAt       DateTime?          @map("started_at")
  completedAt     DateTime?          @map("completed_at")
  createdAt       DateTime           @default(now()) @map("created_at")

  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([videoId])
  @@index([status])
  @@index([contentHash, status])
  @@map("rally_detection_jobs")
}

enum DetectionJobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

// ============================================================================
// Export Jobs
// ============================================================================

model ExportJob {
  id        String       @id @default(uuid())
  sessionId String       @map("session_id")
  userId    String       @map("user_id")
  tier      UserTier     @default(FREE)
  status    ExportStatus @default(PENDING)
  progress  Int          @default(0)
  outputKey String?      @map("output_key")
  error     String?
  config    Json
  rallies   Json
  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([userId])
  @@index([status])
  @@map("export_jobs")
}

enum ExportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// ============================================================================
// Rally Confirmation (Trimmed Video Generation)
// ============================================================================

enum ConfirmationStatus {
  PENDING
  PROCESSING
  CONFIRMED
  FAILED
}

model RallyConfirmation {
  id                 String             @id @default(uuid())
  videoId            String             @unique @map("video_id")
  status             ConfirmationStatus @default(PENDING)

  // Original video (preserved)
  originalS3Key      String             @map("original_s3_key")
  originalDurationMs Int                @map("original_duration_ms")

  // Trimmed video (generated)
  trimmedS3Key       String?            @map("trimmed_s3_key")
  trimmedDurationMs  Int?               @map("trimmed_duration_ms")

  // Timestamp mapping: [{rallyId, originalStartMs, originalEndMs, trimmedStartMs, trimmedEndMs}]
  timestampMappings  Json               @map("timestamp_mappings")

  progress           Int                @default(0)
  error              String?

  createdAt          DateTime           @default(now()) @map("created_at")
  confirmedAt        DateTime?          @map("confirmed_at")

  video              Video              @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([videoId])
  @@index([status])
  @@map("rally_confirmations")
}

// ============================================================================
// User Feedback
// ============================================================================

enum FeedbackType {
  BUG
  FEATURE
  FEEDBACK
}

model Feedback {
  id        String       @id @default(uuid())
  userId    String?      @map("user_id")
  type      FeedbackType
  message   String
  email     String?
  userAgent String?      @map("user_agent")
  pageUrl   String?      @map("page_url")
  createdAt DateTime     @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([type])
  @@map("feedback")
}
