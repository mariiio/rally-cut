generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// User & Identity
// ============================================================================

enum UserTier {
  FREE
  PRO
  ELITE
}

model User {
  id            String    @id @default(uuid())
  email         String?   @unique
  name          String?
  avatarUrl     String?   @map("avatar_url")
  emailVerified DateTime? @map("email_verified")
  passwordHash  String?   @map("password_hash")
  tier          UserTier  @default(FREE)
  tierExpiresAt DateTime? @map("tier_expires_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  convertedAt   DateTime? @map("converted_at")
  lastActiveAt  DateTime? @map("last_active_at") /// Last time user accessed content (for inactivity cleanup)

  videos              Video[]
  sessions            Session[]
  anonymousIdentities AnonymousIdentity[]
  accounts            Account[]
  sessionMemberships  SessionMember[]
  videoMemberships    VideoMember[]
  highlights          Highlight[]
  usageQuota          UserUsageQuota?
  feedback            Feedback[]
  accessRequests      AccessRequest[]  @relation("accessRequests")
  resolvedRequests    AccessRequest[]  @relation("resolvedRequests")
  cameraEdits         RallyCameraEdit[]
  videoCameraSettings VideoCameraSettings[]

  @@index([tier])
  @@map("users")
}

model Account {
  id                String  @id @default(uuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model UserUsageQuota {
  id               String   @id @default(uuid())
  userId           String   @unique @map("user_id")
  periodStart      DateTime @map("period_start")
  detectionsUsed   Int      @default(0) @map("detections_used")
  uploadsThisMonth Int      @default(0) @map("uploads_this_month")
  createdAt        DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_usage_quotas")
}

model AnonymousIdentity {
  id        String   @id @default(uuid())
  visitorId String   @unique @map("visitor_id")
  userId    String   @map("user_id")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("anonymous_identities")
}

// ============================================================================
// Session Sharing
// ============================================================================

enum MemberRole {
  VIEWER
  EDITOR
  ADMIN
}

model SessionShare {
  id        String     @id @default(uuid())
  sessionId String     @map("session_id")
  token     String     @unique @default(uuid())
  role      MemberRole @default(VIEWER)
  createdAt DateTime   @default(now()) @map("created_at")

  session Session         @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  members SessionMember[]

  @@unique([sessionId, role])
  @@index([sessionId])
  @@map("session_shares")
}

model SessionMember {
  id             String     @id @default(uuid())
  sessionShareId String     @map("session_share_id")
  userId         String     @map("user_id")
  role           MemberRole @default(VIEWER)
  joinedAt       DateTime   @default(now()) @map("joined_at")

  sessionShare SessionShare @relation(fields: [sessionShareId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionShareId, userId])
  @@index([userId])
  @@index([sessionShareId])
  @@map("session_members")
}

// ============================================================================
// Video Sharing
// ============================================================================

model VideoShare {
  id        String     @id @default(uuid())
  videoId   String     @map("video_id")
  token     String     @unique @default(uuid())
  role      MemberRole @default(VIEWER)
  createdAt DateTime   @default(now()) @map("created_at")

  video   Video         @relation(fields: [videoId], references: [id], onDelete: Cascade)
  members VideoMember[]

  @@unique([videoId, role])
  @@index([videoId])
  @@map("video_shares")
}

model VideoMember {
  id           String     @id @default(uuid())
  videoShareId String     @map("video_share_id")
  userId       String     @map("user_id")
  role         MemberRole @default(VIEWER)
  joinedAt     DateTime   @default(now()) @map("joined_at")

  videoShare VideoShare @relation(fields: [videoShareId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([videoShareId, userId])
  @@index([userId])
  @@index([videoShareId])
  @@map("video_members")
}

enum AccessRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
}

model AccessRequest {
  id          String              @id @default(uuid())
  sessionId   String              @map("session_id")
  userId      String              @map("user_id")
  status      AccessRequestStatus @default(PENDING)
  message     String?
  requestedAt DateTime            @default(now()) @map("requested_at")
  resolvedAt  DateTime?           @map("resolved_at")
  resolvedBy  String?             @map("resolved_by")

  session  Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user     User    @relation("accessRequests", fields: [userId], references: [id], onDelete: Cascade)
  resolver User?   @relation("resolvedRequests", fields: [resolvedBy], references: [id], onDelete: SetNull)

  @@unique([sessionId, userId])
  @@index([sessionId, status])
  @@index([userId])
  @@map("access_requests")
}

// ============================================================================
// Session & Video (Many-to-Many via SessionVideo)
// ============================================================================

enum SessionType {
  REGULAR
  ALL_VIDEOS
}

model Session {
  id        String      @id @default(uuid())
  userId    String?     @map("user_id")
  name      String
  type      SessionType @default(REGULAR)
  expiresAt DateTime?   @map("expires_at")
  deletedAt DateTime?   @map("deleted_at")
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")

  user           User?           @relation(fields: [userId], references: [id], onDelete: SetNull)
  sessionVideos  SessionVideo[]
  highlights     Highlight[]
  shares         SessionShare[]
  exportJobs     ExportJob[]
  accessRequests AccessRequest[]

  @@index([userId])
  @@index([userId, deletedAt])
  @@index([expiresAt])
  @@index([deletedAt])
  @@map("sessions")
}

model Video {
  id            String      @id @default(uuid())
  userId        String?     @map("user_id")
  name          String
  filename      String
  s3Key         String      @map("s3_key")
  /// SHA-256 hex hash for deduplication. Files >50MB: hash of first/last 10MB + metadata.
  contentHash   String      @map("content_hash")
  status        VideoStatus @default(PENDING)
  durationMs    Int?        @map("duration_ms")
  width         Int?
  height        Int?
  fps           Float?      /// Frames per second of original video
  fileSizeBytes BigInt?     @map("file_size_bytes")
  expiresAt     DateTime?   @map("expires_at")
  deletedAt     DateTime?   @map("deleted_at")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  // Video optimization processing
  processingStatus      ProcessingStatus @default(PENDING) @map("processing_status")
  processingAttempts    Int              @default(0) @map("processing_attempts")
  processedS3Key        String?          @map("processed_s3_key")
  originalS3Key         String?          @map("original_s3_key") /// Original upload path before optimization overwrites s3Key
  processedAt           DateTime?        @map("processed_at")
  processingError       String?          @map("processing_error")
  originalFileSizeBytes BigInt?          @map("original_file_size_bytes")

  // Poster and proxy for fast loading
  posterS3Key           String?          @map("poster_s3_key")
  proxyS3Key            String?          @map("proxy_s3_key")
  proxyFileSizeBytes    BigInt?          @map("proxy_file_size_bytes")
  proxyGeneratedAt      DateTime?        @map("proxy_generated_at")
  proxyLastAccessedAt   DateTime?        @map("proxy_last_accessed_at")

  // Quality downgrade tracking (FREE tier loses original quality after 7 days)
  qualityDowngradedAt   DateTime?        @map("quality_downgraded_at")

  user           User?                 @relation(fields: [userId], references: [id], onDelete: SetNull)
  sessionVideos  SessionVideo[]
  rallies        Rally[]
  detectionJobs  RallyDetectionJob[]
  confirmation   RallyConfirmation?
  cameraSettings VideoCameraSettings[]
  shares         VideoShare[]

  @@index([userId])
  @@index([userId, deletedAt])
  @@index([contentHash])
  @@index([status])
  @@index([expiresAt])
  @@index([deletedAt])
  @@index([processingStatus])
  @@map("videos")
}

model SessionVideo {
  id        String   @id @default(uuid())
  sessionId String   @map("session_id")
  videoId   String   @map("video_id")
  order     Int      @default(0)
  addedAt   DateTime @default(now()) @map("added_at")

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  video   Video   @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([sessionId, videoId])
  @@index([sessionId])
  @@index([videoId])
  @@map("session_videos")
}

enum VideoStatus {
  PENDING
  UPLOADED
  DETECTING
  DETECTED
  ERROR
}

enum ProcessingStatus {
  PENDING
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
  SKIPPED
}

// ============================================================================
// Rally & Highlight
// ============================================================================

model Rally {
  id              String           @id @default(uuid())
  videoId         String           @map("video_id")
  startMs         Int              @map("start_ms")
  endMs           Int              @map("end_ms")
  confidence      Float?
  status          RallyStatus      @default(CONFIRMED)
  rejectionReason RejectionReason? @map("rejection_reason")
  scoreA          Int?             @map("score_a")
  scoreB          Int?             @map("score_b")
  servingTeam     ServingTeam?     @map("serving_team")
  notes           String?
  order           Int              @default(0)
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")

  video            Video             @relation(fields: [videoId], references: [id], onDelete: Cascade)
  highlightRallies HighlightRally[]
  cameraEdits      RallyCameraEdit[]
  playerTrack      PlayerTrack?

  @@index([videoId])
  @@index([videoId, startMs])
  @@index([videoId, status])
  @@map("rallies")
}

// ============================================================================
// Player Tracking (debug visualization)
// ============================================================================

enum PlayerTrackStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model PlayerTrack {
  id               String            @id @default(uuid())
  rallyId          String            @unique @map("rally_id")
  status           PlayerTrackStatus @default(PENDING)

  frameCount       Int?              @map("frame_count")
  fps              Float?            @map("fps") // Video fps at time of tracking
  detectionRate    Float?            @map("detection_rate")
  avgConfidence    Float?            @map("avg_confidence")
  avgPlayerCount   Float?            @map("avg_player_count")
  uniqueTrackCount Int?              @map("unique_track_count")
  positionsJson    Json?             @map("positions_json") // Flat array of {frameNumber, trackId, x, y, width, height, confidence}

  // Court split info for debug overlay
  courtSplitY      Float?            @map("court_split_y")
  primaryTrackIds  Json?             @map("primary_track_ids") // Array of track IDs

  // Ball phase detection results
  ballPhasesJson    Json?             @map("ball_phases_json") // Array of {phase, frameStart, frameEnd, velocity, ballX, ballY}
  serverInfoJson    Json?             @map("server_info_json") // {trackId, confidence, serveFrame, serveVelocity, isNearCourt}
  ballPositionsJson Json?             @map("ball_positions_json") // Array of {frameNumber, x, y, confidence} for trajectory overlay

  processingTimeMs Int?              @map("processing_time_ms")
  modelVersion     String?           @map("model_version")
  error            String?

  createdAt        DateTime          @default(now()) @map("created_at")
  completedAt      DateTime?         @map("completed_at")

  rally            Rally             @relation(fields: [rallyId], references: [id], onDelete: Cascade)

  @@index([rallyId])
  @@index([status])
  @@map("player_tracks")
}

// ============================================================================
// Camera Tracking (Instagram-style edits)
// ============================================================================

enum AspectRatio {
  ORIGINAL // 16:9
  VERTICAL // 9:16
}

enum CameraEasing {
  LINEAR
  EASE_IN
  EASE_OUT
  EASE_IN_OUT
}

model RallyCameraEdit {
  id          String      @id @default(uuid())
  rallyId     String      @map("rally_id")
  userId      String?     @map("user_id")
  aspectRatio AspectRatio @default(ORIGINAL) @map("aspect_ratio")
  enabled     Boolean     @default(false)
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  rally     Rally            @relation(fields: [rallyId], references: [id], onDelete: Cascade)
  user      User?            @relation(fields: [userId], references: [id], onDelete: Cascade)
  keyframes CameraKeyframe[]

  @@unique([rallyId, userId])
  @@index([userId])
  @@map("rally_camera_edits")
}

model CameraKeyframe {
  id            String       @id @default(uuid())
  rallyCameraId String       @map("rally_camera_id")
  timeOffset    Float        @map("time_offset") // 0.0-1.0 within rally
  positionX     Float        @default(0.5) @map("position_x") // 0-1, center=0.5
  positionY     Float        @default(0.5) @map("position_y")
  zoom          Float        @default(1.0) // 1.0-3.0
  rotation      Float        @default(0.0) // degrees, clockwise positive
  easing        CameraEasing @default(EASE_IN_OUT)
  createdAt     DateTime     @default(now()) @map("created_at")

  rallyCameraEdit RallyCameraEdit @relation(fields: [rallyCameraId], references: [id], onDelete: Cascade)

  @@index([rallyCameraId])
  @@map("camera_keyframes")
}

// Global camera settings at video level (applies as base for all rallies)
model VideoCameraSettings {
  id        String   @id @default(uuid())
  videoId   String   @map("video_id")
  userId    String?  @map("user_id")
  zoom      Float    @default(1.0)
  positionX Float    @default(0.5) @map("position_x")
  positionY Float    @default(0.5) @map("position_y")
  rotation  Float    @default(0.0) // degrees
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)
  user  User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([videoId, userId])
  @@index([userId])
  @@map("video_camera_settings")
}

enum ServingTeam {
  A
  B
}

enum RallyStatus {
  CONFIRMED
  SUGGESTED
}

enum RejectionReason {
  INSUFFICIENT_WINDOWS
  TOO_SHORT
  SPARSE_DENSITY
}

model Highlight {
  id              String   @id @default(uuid())
  sessionId       String   @map("session_id")
  createdByUserId String?  @map("created_by_user_id")
  name            String
  color           String   @default("#FF6B6B")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  session          Session          @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  createdByUser    User?            @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)
  highlightRallies HighlightRally[]

  @@index([sessionId])
  @@index([createdByUserId])
  @@map("highlights")
}

model HighlightRally {
  id          String @id @default(uuid())
  highlightId String @map("highlight_id")
  rallyId     String @map("rally_id")
  order       Int    @default(0)

  highlight Highlight @relation(fields: [highlightId], references: [id], onDelete: Cascade)
  rally     Rally     @relation(fields: [rallyId], references: [id], onDelete: Cascade)

  @@unique([highlightId, rallyId])
  @@index([rallyId])
  @@map("highlight_rallies")
}

// ============================================================================
// Detection Jobs
// ============================================================================

model RallyDetectionJob {
  id              String             @id @default(uuid())
  videoId         String             @map("video_id")
  /// SHA-256 hex hash for caching detection results across uploads with same content.
  contentHash     String             @map("content_hash")
  status          DetectionJobStatus @default(PENDING)
  progress        Float?             @default(0)
  progressMessage String?            @map("progress_message")
  resultS3Key     String?            @map("result_s3_key")
  errorMessage    String?            @map("error_message")
  startedAt       DateTime?          @map("started_at")
  completedAt     DateTime?          @map("completed_at")
  createdAt       DateTime           @default(now()) @map("created_at")

  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([videoId])
  @@index([status])
  @@index([contentHash, status])
  @@map("rally_detection_jobs")
}

enum DetectionJobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

// ============================================================================
// Export Jobs
// ============================================================================

model ExportJob {
  id        String       @id @default(uuid())
  sessionId String       @map("session_id")
  userId    String       @map("user_id")
  tier      UserTier     @default(FREE)
  status    ExportStatus @default(PENDING)
  progress  Int          @default(0)
  outputKey String?      @map("output_key")
  error     String?
  config    Json
  rallies   Json
  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([userId])
  @@index([status])
  @@map("export_jobs")
}

enum ExportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// ============================================================================
// Rally Confirmation (Trimmed Video Generation)
// ============================================================================

enum ConfirmationStatus {
  PENDING
  PROCESSING
  CONFIRMED
  FAILED
}

model RallyConfirmation {
  id                 String             @id @default(uuid())
  videoId            String             @unique @map("video_id")
  status             ConfirmationStatus @default(PENDING)

  // Original video (preserved)
  originalS3Key      String             @map("original_s3_key")
  originalDurationMs Int                @map("original_duration_ms")

  // Trimmed video (generated)
  trimmedS3Key       String?            @map("trimmed_s3_key")
  trimmedDurationMs  Int?               @map("trimmed_duration_ms")
  proxyS3Key         String?            @map("proxy_s3_key")  // 720p proxy for trimmed video

  // Timestamp mapping: [{rallyId, originalStartMs, originalEndMs, trimmedStartMs, trimmedEndMs}]
  timestampMappings  Json               @map("timestamp_mappings")

  progress           Int                @default(0)
  error              String?

  createdAt          DateTime           @default(now()) @map("created_at")
  confirmedAt        DateTime?          @map("confirmed_at")

  video              Video              @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([videoId])
  @@index([status])
  @@map("rally_confirmations")
}

// ============================================================================
// User Feedback
// ============================================================================

enum FeedbackType {
  BUG
  FEATURE
  FEEDBACK
}

model Feedback {
  id        String       @id @default(uuid())
  userId    String?      @map("user_id")
  type      FeedbackType
  message   String
  email     String?
  userAgent String?      @map("user_agent")
  pageUrl   String?      @map("page_url")
  createdAt DateTime     @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([type])
  @@map("feedback")
}
